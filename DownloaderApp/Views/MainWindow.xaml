<mah:MetroWindow x:Class="DownloaderApp.Views.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:mah="http://metro.mahapps.com/winfx/xaml/controls"
        xmlns:iconPacks="http://metro.mahapps.com/winfx/xaml/iconpacks"
        xmlns:local="clr-namespace:DownloaderApp.Views"
        xmlns:vm="clr-namespace:DownloaderApp.ViewModels"
        xmlns:models="clr-namespace:DownloaderApp.Models"
        xmlns:conv="clr-namespace:DownloaderApp.Converters"
        mc:Ignorable="d"
        Title="Downloader App" Height="700" Width="850"
        MinHeight="600" MinWidth="750"
        GlowBrush="{DynamicResource MahApps.Brushes.Accent}"
        BorderThickness="1" 
        BorderBrush="{DynamicResource MahApps.Brushes.Accent}">

    <mah:MetroWindow.Resources>
        <conv:BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter"/>
        <conv:InverseBooleanConverter x:Key="InverseBooleanConverter"/>
        <Style x:Key="CancelButtonStyle" TargetType="Button" BasedOn="{StaticResource MahApps.Styles.Button.Square}">
            <Setter Property="Visibility" Value="Collapsed"/>
            <Setter Property="MinWidth" Value="120"/>
            <Setter Property="Padding" Value="10,5,15,5"/>
            <Style.Triggers>
                <DataTrigger Binding="{Binding IsDownloading}" Value="True">
                    <Setter Property="Visibility" Value="Visible"/>
                </DataTrigger>
            </Style.Triggers>
        </Style>
        <Style x:Key="StartButtonStyle" TargetType="Button" BasedOn="{StaticResource MahApps.Styles.Button.Square.Accent}">
            <Setter Property="Padding" Value="10,5,15,5"/>
            <Setter Property="MinWidth" Value="120"/>
            <Setter Property="Visibility" Value="Visible"/>
            <Style.Triggers>
                <DataTrigger Binding="{Binding IsDownloading}" Value="True">
                    <Setter Property="Visibility" Value="Collapsed"/>
                </DataTrigger>
            </Style.Triggers>
        </Style>
        <Style TargetType="Button" BasedOn="{StaticResource MahApps.Styles.Button.Square}">
            <Setter Property="Padding" Value="10,5,15,5"/>
            <Setter Property="MinWidth" Value="100"/>
            <Setter Property="Margin" Value="0,0,5,0"/>
        </Style>
    </mah:MetroWindow.Resources>

    <Grid Margin="15">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <GroupBox Grid.Row="0" Header="Параметры загрузки" Margin="0,0,0,15">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>

                <StackPanel Grid.Row="0" Grid.Column="0" Margin="0,0,10,0">
                    <TextBlock Text="База данных:" Margin="0,5,0,2" FontWeight="SemiBold" Foreground="{DynamicResource MahApps.Brushes.Gray1}"/>
                    <ComboBox ItemsSource="{Binding AvailableDatabases}"
                              SelectedItem="{Binding SelectedDatabase}"
                              DisplayMemberPath="Name"
                              Margin="0,0,0,10"/>

                    <TextBlock Text="Тема (БД):" Margin="0,0,0,2" FontWeight="SemiBold" Foreground="{DynamicResource MahApps.Brushes.Gray1}"/>
                    <ComboBox ItemsSource="{Binding AvailableThemes}"
                              SelectedItem="{Binding SelectedTheme}"
                              Margin="0,0,0,10">
                        <ComboBox.ItemTemplate>
                            <DataTemplate DataType="{x:Type models:ThemeInfo}">
                                <StackPanel Orientation="Horizontal">
                                    <TextBlock Text="{Binding Name}" Margin="0,0,5,0"/>
                                    <TextBlock Text="{Binding Id, StringFormat='({0})'}" Foreground="{DynamicResource MahApps.Brushes.Gray2}"/>
                                </StackPanel>
                            </DataTemplate>
                        </ComboBox.ItemTemplate>
                    </ComboBox>

                     <TextBlock Text="Дата начала:" Margin="0,0,0,2" FontWeight="SemiBold" Foreground="{DynamicResource MahApps.Brushes.Gray1}"/>
                     <DatePicker SelectedDate="{Binding BeginDate}"
                                Margin="0,0,0,10"/>

                     <TextBlock Text="Фильтр ID:" Margin="0,5,0,2" FontWeight="SemiBold" Foreground="{DynamicResource MahApps.Brushes.Gray1}"/>
                     <TextBox Text="{Binding SelectedFilterId, UpdateSourceTrigger=PropertyChanged}"
                             mah:TextBoxHelper.Watermark="Введите ID (число, 0 - нет)"
                             mah:TextBoxHelper.ClearTextButton="True"
                             Margin="0,0,0,10"/>

                    <mah:ToggleSwitch Header="Проверка ошибок (flProv)"
                                      IsOn="{Binding CheckProvError}"
                                      VerticalAlignment="Center" Margin="0,5,0,10"
                                      OnContent="Вкл" OffContent="Выкл"/>

                </StackPanel>

                 <StackPanel Grid.Row="0" Grid.Column="1" Margin="10,0,0,0">
                    <TextBlock Text="Источник:" Margin="0,5,0,2" FontWeight="SemiBold" Foreground="{DynamicResource MahApps.Brushes.Gray1}"/>
                    <ComboBox SelectedIndex="{Binding SelectedSourceId}"
                              Margin="0,0,0,10">
                        <ComboBoxItem Content="Сетевой путь"/>
                        <ComboBoxItem Content="FTP"/>
                        <ComboBoxItem Content="Локальный/Другой"/>
                    </ComboBox>

                     <TextBlock Height="{Binding ElementName=cmbTheme, Path=ActualHeight}" Margin="0,0,0,10" Visibility="Hidden"/>

                     <TextBlock Text="Дата конца:" Margin="0,0,0,2" FontWeight="SemiBold" Foreground="{DynamicResource MahApps.Brushes.Gray1}"/>
                     <DatePicker SelectedDate="{Binding EndDate}"
                                Margin="0,0,0,10"/>

                     <TextBlock Height="{Binding ElementName=txtFilter, Path=ActualHeight}" Margin="0,0,0,10" Visibility="Hidden"/>

                     <mah:ToggleSwitch Header="Игнорировать ошибки файлов"
                                      IsOn="{Binding IgnoreDownloadErrors}"
                                      VerticalAlignment="Center" Margin="0,5,0,10"
                                      OnContent="Да" OffContent="Нет"/>

                 </StackPanel>
                 <Grid.IsEnabled>
                     <Binding Path="IsDownloading" Converter="{StaticResource InverseBooleanConverter}"/>
                 </Grid.IsEnabled>
            </Grid>
        </GroupBox>

        <StackPanel Grid.Row="1" Orientation="Horizontal" Margin="0,0,0,10">
            <Button Command="{Binding StartDownloadCommand}"
                    Style="{StaticResource StartButtonStyle}"
                    ToolTip="Начать загрузку файлов">
                <StackPanel Orientation="Horizontal">
                    <iconPacks:PackIconMaterial Kind="Play" VerticalAlignment="Center" Margin="0,0,5,0" />
                    <TextBlock Text="_Начать загрузку"/>
                </StackPanel>
            </Button>
            <Button Command="{Binding CancelDownloadCommand}"
                    Style="{StaticResource CancelButtonStyle}"
                    IsCancel="True"
                    ToolTip="Отменить текущую загрузку">
                <StackPanel Orientation="Horizontal">
                    <iconPacks:PackIconMaterial Kind="Cancel" VerticalAlignment="Center" Margin="0,0,5,0" />
                    <TextBlock Text="_Отмена"/>
                </StackPanel>
            </Button>
            <Button Command="{Binding OpenSettingsCommand}"
                    IsEnabled="{Binding IsDownloading, Converter={StaticResource InverseBooleanConverter}}"
                    ToolTip="Открыть настройки приложения">
                <StackPanel Orientation="Horizontal">
                     <iconPacks:PackIconMaterial Kind="Cog" VerticalAlignment="Center" Margin="0,0,5,0" />
                     <TextBlock Text="_Настройки"/>
                </StackPanel>
            </Button>
            <TextBlock Text="{Binding StatusMessage}"
                       VerticalAlignment="Center"
                       Foreground="{DynamicResource MahApps.Brushes.Gray4}"
                       HorizontalAlignment="Right" Margin="10,0,0,0"/>
        </StackPanel>

        <GroupBox Grid.Row="2" Header="Лог выполнения" Margin="0,0,0,10">
             <ListBox ItemsSource="{Binding LogMessages}"
                      HorizontalContentAlignment="Stretch"
                      BorderThickness="0"
                      ScrollViewer.HorizontalScrollBarVisibility="Disabled">
                 <ListBox.ItemTemplate>
                     <DataTemplate>
                         <TextBlock Text="{Binding}" TextWrapping="Wrap" Margin="2"/>
                     </DataTemplate>
                 </ListBox.ItemTemplate>
                 <ListBox.ItemContainerStyle>
                     <Style TargetType="ListBoxItem">
                         <Setter Property="Focusable" Value="False"/>
                         <Setter Property="Template">
                             <Setter.Value>
                                 <ControlTemplate TargetType="ListBoxItem">
                                     <ContentPresenter/>
                                 </ControlTemplate>
                             </Setter.Value>
                         </Setter>
                     </Style>
                 </ListBox.ItemContainerStyle>
             </ListBox>
        </GroupBox>

        <Grid Grid.Row="3" Margin="0,5,0,0"
              Visibility="{Binding IsDownloading, Converter={StaticResource BooleanToVisibilityConverter}}">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>

            <mah:MetroProgressBar Grid.Column="0"
                                  Value="{Binding ProcessedFiles, Mode=OneWay}"
                                  Maximum="{Binding TotalFiles, Mode=OneWay}"
                                  IsIndeterminate="{Binding IsIndeterminateProgress}"
                                  VerticalAlignment="Center" Margin="0,0,10,0"/>

            <TextBlock Grid.Column="1" VerticalAlignment="Center" Foreground="{DynamicResource MahApps.Brushes.Gray1}">
                <Run Text="Обработано:"/>
                <Run Text="{Binding ProcessedFiles, Mode=OneWay}" FontWeight="Bold"/>
                <Run Text="/"/>
                <Run Text="{Binding TotalFiles, Mode=OneWay}" FontWeight="Bold"/>
                <Run Text="("/>
                <Run Text="{Binding CurrentFileName, Mode=OneWay, TargetNullValue='файл...'}"/>
                <Run Text=")"/>
            </TextBlock>
        </Grid>

    </Grid>
</mah:MetroWindow> 